I"ŞD<h2 id="æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</h2>
<p>è§£å†³å•ä¸€tokençš„å®‰å…¨é—®é¢˜,è®¾ç½®2ä¸ªtokenä¸€ä¸ªå¯¹æ¥ä¸šåŠ¡,æœ‰éœ€æ±‚å°±å¸¦ç€ä¸šåŠ¡tokenå»è®¤è¯ç„¶åæ“ä½œç›¸å…³åŠŸèƒ½,æœ‰æ•ˆæœŸè¾ƒçŸ­,2å°æ—¶;å¦ä¸€ä¸ªtokenä¸“é—¨ç”¨æ¥åˆ·æ–°ä¸šåŠ¡token,ç®€ç§°åˆ·æ–°token,å…·æœ‰è¾ƒé•¿çš„è¿‡æœŸæ—¶é—´,14å¤©;
å½“ä¸šåŠ¡tokenè¿‡æœŸæ—¶,å¿…é¡»æºå¸¦åˆ·æ–°tokené€šè¿‡putæ¥å£æ¥å®ç°tokençš„åˆ·æ–°,æ–°çš„ä¸šåŠ¡tokenè¿˜æ˜¯å­˜æ´»2å°æ—¶,è¿™æœŸé—´åˆ·æ–°tokenä¸€ç›´ä¸å˜,ç›´åˆ°14å¤©ååˆ·æ–°tokenè¿‡æœŸ,é‡æ–°å¼€å§‹æ–°ä¸€è½®çš„å¾ªç¯;åœ¨è°ƒç”¨ç”Ÿæˆtokençš„æ¥å£æ—¶,åˆ©ç”¨ä¸€ä¸ªå¸ƒå°”å‹æ ‡è¯†need_refresh_tokenæ¥åˆ¤æ–­æ˜¯å¦ç”Ÿæˆåˆ·æ–°token,ä¿è¯æœ‰æ•ˆæœŸå†…åªä¼šç”Ÿæˆæ–°çš„ä¸šåŠ¡tokenè€Œåˆ·æ–°tokenåˆ™ä¸€ç›´ä¿æŒä¸å˜</p>
<h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h2>
<p>ç”¨Pycharmçš„æœ‹å‹å¯ä»¥åœ¨ä½ é¡¹ç›®çš„Sources Root ç›®å½•ä¸‹é¢çš„utilsç›®å½•(å¦‚æœæœ‰,æ²¡æœ‰å¯ä»¥æ–°å»º)æ–°å»ºä¸€ä¸ªmiddleware.pyæ–‡ä»¶ç”¨æ¥å­˜æ”¾å„ç§ä¸­é—´ä»¶ä»£ç </p>
<ul>
  <li>Sources Root ç›®å½•, ç”¨æ¥æœåŒ…çš„ç›®å½•, å¯ä»¥è§£å†³Pycharmå±‚é¢çš„ä»£ç å¯¼åŒ…ç±»æŠ¥çº¢æç¤º</li>
  <li>å…·ä½“æ“ä½œ:å³å‡»æ–‡ä»¶å¤¹â€“&gt;Mark Directory Asâ€“&gt;Sources Root</li>
</ul>

<p>åœ¨å·¥å…·æ–‡ä»¶å¤¹utilsä¸‹å®šä¹‰jwtçš„ç”Ÿæˆå’Œæ ¡éªŒçš„å·¥å…·å‡½æ•°:
æ­¤å¤„ä½¿ç”¨çš„æ˜¯pyjwtä¸‰æ–¹åŒ… <code class="language-plaintext highlighter-rouge">$ pip install pyjwt</code>ç­¾åæ‰€ç”¨ç®—æ³•<code class="language-plaintext highlighter-rouge">HS256</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">jwt</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>


<span class="k">def</span> <span class="nf">generate_jwt</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">expiry</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">"""
    ç”Ÿæˆjwt
    :param payload: dict è½½è·
    :param expiry: datetime æœ‰æ•ˆæœŸ
    :param secret: å¯†é’¥
    :return: jwt
    """</span>
    <span class="n">_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">'exp'</span><span class="p">:</span> <span class="n">expiry</span><span class="p">}</span>
    <span class="n">_payload</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">secret</span><span class="p">:</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">current_app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_SECRET'</span><span class="p">]</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">_payload</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">token</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">verify_jwt</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">"""
    æ£€éªŒjwt
    :param token: jwt
    :param secret: å¯†é’¥
    :return: dict: payload
    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">secret</span><span class="p">:</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">current_app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_SECRET'</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="p">[</span><span class="s">'HS256'</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">PyJWTError</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">payload</span>
</code></pre></div></div>
<h2 id="ä»£ç å®ç°">ä»£ç å®ç°</h2>
<p>1.middlewares.pyä¸­å®šä¹‰JWTçš„è®¤è¯å‡½æ•°jwt_authentication</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span><span class="p">,</span> <span class="n">request</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">jwt_util</span>

<span class="c1"># ç”¨æˆ·è®¤è¯æœºåˆ¶==&gt;æ¯æ¬¡è¯·æ±‚å‰è·å–å¹¶æ ¡éªŒtoken
</span>
<span class="c1"># @app.before_request ä¸ä½¿@è°ƒç”¨è£…é¥°å™¨ åœ¨ initæ–‡ä»¶ç›´æ¥è£…é¥°
</span><span class="k">def</span> <span class="nf">jwt_authentication</span><span class="p">():</span>
    <span class="s">"""
    1.è·å–è¯·æ±‚å¤´Authorizationä¸­çš„token
    2.åˆ¤æ–­æ˜¯å¦ä»¥ Bearerå¼€å¤´
    3.ä½¿ç”¨jwtæ¨¡å—è¿›è¡Œæ ¡éªŒ
    4.åˆ¤æ–­æ ¡éªŒç»“æœ,æˆåŠŸå°±æå–tokenä¸­çš„è½½è·ä¿¡æ¯,èµ‹å€¼ç»™gå¯¹è±¡ä¿å­˜
    """</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Authorization'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auth</span> <span class="ow">and</span> <span class="n">auth</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'Bearer '</span><span class="p">):</span>
        <span class="c1"># æå–token 0-6 è¢«Bearerå’Œç©ºæ ¼å ç”¨ å–ä¸‹æ ‡7ä»¥åçš„æ‰€æœ‰å­—ç¬¦
</span>        <span class="n">token</span> <span class="o">=</span> <span class="n">auth</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
        <span class="c1"># æ ¡éªŒtoken
</span>        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt_util</span><span class="p">.</span><span class="n">verify_jwt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="c1"># åˆ¤æ–­tokençš„æ ¡éªŒç»“æœ
</span>        <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
            <span class="c1"># è·å–è½½è·ä¸­çš„ä¿¡æ¯èµ‹å€¼ç»™gå¯¹è±¡
</span>            <span class="n">g</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">)</span>
            <span class="n">g</span><span class="p">.</span><span class="n">refresh</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'refresh'</span><span class="p">)</span>
</code></pre></div></div>
<p>2.åœ¨initæ–‡ä»¶ä¸­ç›´æ¥ä»¥è°ƒç”¨é’©å­å‡½æ•°çš„æ–¹å¼è£…é¥°å‡½æ•°</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># æ·»åŠ è¯·æ±‚é’©å­
</span><span class="kn">from</span> <span class="nn">utils.middlewares</span> <span class="kn">import</span> <span class="n">jwt_authentication</span>
<span class="n">app</span><span class="p">.</span><span class="n">before_request</span><span class="p">(</span><span class="n">jwt_authentication</span><span class="p">)</span>
</code></pre></div></div>
<p>3.åœ¨è§†å›¾æ–‡ä»¶ä¸­å®šä¹‰tokençš„ç”Ÿæˆæ–¹æ³•</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_generate_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">need_refresh_token</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
	<span class="s">"""
	ç”Ÿæˆtoken å’Œrefresh_token
	:param user_id: ç”¨æˆ·id
	:return: token2å°æ—¶, refresh_token14å¤©
	"""</span>
	<span class="k">pass</span>
	<span class="c1"># ç”Ÿæˆæ—¶é—´ä¿¡æ¯
</span>	<span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span>
	<span class="c1"># æŒ‡å®šæœ‰æ•ˆæœŸ  ä¸šåŠ¡token -- 2å°æ—¶
</span>	<span class="n">expire_time</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">current_app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_EXPIRY_HOURS'</span><span class="p">])</span>

	<span class="c1"># ç”Ÿæˆä¸šåŠ¡token  refresh æ ‡è¯†æ˜¯å¦æ˜¯åˆ·æ–°token
</span>	<span class="n">token</span> <span class="o">=</span> <span class="n">generate_jwt</span><span class="p">({</span><span class="s">'user_id'</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s">'refresh'</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span> <span class="n">expiry</span><span class="o">=</span><span class="n">expire_time</span><span class="p">)</span>
	
	<span class="c1"># ç»™åˆ·æ–°tokenè®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼None
</span>	<span class="n">refresh_token</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="c1"># æ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ¤æ–­æ˜¯å¦éœ€è¦ç”Ÿæˆåˆ·æ–°token
</span>	<span class="c1"># ä¸éœ€è¦ç”Ÿæˆçš„ä¼ å…¥need_refresh_token=False,éœ€è¦çš„ä¼ å…¥Trueæˆ–ä¸ä¼ ä½¿ç”¨é»˜è®¤å€¼
</span>	<span class="k">if</span> <span class="n">need_refresh_token</span><span class="p">:</span>
	    <span class="c1"># æŒ‡å®šæœ‰æ•ˆæœŸ  åˆ·æ–°token -- 14å¤©
</span>	    <span class="n">refresh_expires</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">current_app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'JWT_REFRESH_DAYS'</span><span class="p">])</span>
	    <span class="c1"># ç”Ÿæˆåˆ·æ–°token
</span>	    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">generate_jwt</span><span class="p">({</span><span class="s">'user_id'</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s">'refresh'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="n">expiry</span><span class="o">=</span><span class="n">refresh_expires</span><span class="p">)</span>
	<span class="c1"># è¿”å›è¿™ä¸¤ä¸ªtoken
</span>	<span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="n">refresh_token</span>
</code></pre></div></div>
<p>4.åœ¨è§†å›¾æ–‡ä»¶ä¸­å®šä¹‰tokençš„åˆ·æ–°æ–¹æ³•</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        1.æºå¸¦åˆ·æ–°token,è¿”å›ä¸šåŠ¡token
        2.ç”¨æˆ·å¿…é¡»ç™»å½•g.user_id , å¿…é¡»æºå¸¦åˆ·æ–°tokenä¸å…è®¸æºå¸¦ä¸šåŠ¡token
        3.å®¢æˆ·ç«¯è¯·æ±‚å‚æ•° åˆ·æ–°token
        """</span>
        <span class="c1"># 1.åˆ¤æ–­æ˜¯å¦ç™»å½• 2.åˆ¤æ–­refreshå­—æ®µæ˜¯å¦ä¸ºTrue--æ˜¯å¦æ˜¯åˆ·æ–°token
</span>        <span class="k">if</span> <span class="n">g</span><span class="p">.</span><span class="n">user_id</span> <span class="ow">and</span> <span class="n">g</span><span class="p">.</span><span class="n">refresh</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># è°ƒç”¨ç”Ÿæˆtokençš„æ–¹æ³• å‚æ•° need_refresh_token=False ä¸éœ€è¦ç”Ÿæˆåˆ·æ–°token ä»…ç”Ÿæˆä¸šåŠ¡token
</span>            <span class="n">token</span><span class="p">,</span> <span class="n">refresh_token</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_generate_tokens</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">need_refresh_token</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c1"># è¿”å›ä¸šåŠ¡token  ä¿®æ”¹æˆåŠŸçŠ¶æ€ç 201
</span>            <span class="k">return</span> <span class="p">{</span><span class="s">'token'</span><span class="p">:</span> <span class="n">token</span><span class="p">},</span> <span class="mi">201</span>
        <span class="k">else</span><span class="p">:</span>
	    <span class="c1"># å¤±è´¥è¿”å›é”™è¯¯ä¿¡æ¯å’ŒçŠ¶æ€ç 
</span>            <span class="k">return</span> <span class="p">{</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'Wrong Token'</span><span class="p">},</span> <span class="mi">403</span>
        <span class="k">pass</span>
</code></pre></div></div>
<p>5.å¼ºåˆ¶ç™»å½•è£…é¥°å™¨,æ·»åŠ åˆ°è§†å›¾ç±»çš„method_decoratorså­—å…¸/åˆ—è¡¨ä¸­å…¨å±€æˆ–å±€éƒ¨è£…é¥°</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""
ç™»å½•éªŒè¯è£…é¥°å™¨
pythonä¸­çš„è£…é¥°å™¨ï¼šä¼šæ”¹å˜è¢«è£…é¥°å™¨è£…é¥°çš„å‡½æ•°çš„å‡½æ•°å(å±æ€§)
ä½¿ç”¨æ–¹æ³•ï¼šæ”¾åœ¨method_decoratorsä¸­
"""</span>
<span class="kn">import</span> <span class="nn">functools</span>


<span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="c1"># è®©è£…é¥°å™¨è£…é¥°çš„å‡½æ•°å±æ€§ä¸ä¼šå˜ -- nameå±æ€§
</span>    <span class="c1"># ç¬¬1ç§æ–¹æ³•,ä½¿ç”¨functoolsæ¨¡å—çš„wrapsè£…é¥°å†…éƒ¨å‡½æ•°
</span>    <span class="o">@</span><span class="n">functools</span><span class="p">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="p">.</span><span class="n">user_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'User must be authorized.'</span><span class="p">},</span> <span class="mi">401</span>
        <span class="k">elif</span> <span class="n">g</span><span class="p">.</span><span class="n">is_refresh_token</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'Do not use refresh token.'</span><span class="p">},</span> <span class="mi">403</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># ç¬¬2ç§æ–¹æ³•,åœ¨è¿”å›å†…éƒ¨å‡½æ•°ä¹‹å‰,å…ˆä¿®æ”¹wrapperçš„nameå±æ€§
</span>    <span class="c1"># wrapper.__name__ = f.__name__
</span>    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Resource</span>


<span class="k">class</span> <span class="nc">AuthorizationResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="s">"""
    è®¤è¯
    """</span>
    <span class="n">method_decorators</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'post'</span><span class="p">:</span> <span class="p">[</span><span class="n">login_required</span><span class="p">,</span><span class="n">set_db_to_write</span><span class="p">],</span>
        <span class="s">'put'</span><span class="p">:</span> <span class="p">[</span><span class="n">login_required</span><span class="p">,</span><span class="n">set_db_to_read</span><span class="p">]</span>
    <span class="p">}</span>
</code></pre></div></div>
:ET